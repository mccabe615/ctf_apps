(function(a){function c(a,b){var c,d;return c=b.parentNode,d=b.nextSibling,d?c.insertBefore(a,d):c.appendChild(a),a}function d(a,b,c){var d,e=a.getDoc().createTreeWalker(b,NodeFilter.SHOW_TEXT,null,!1);if(c)return e.nextNode();while(d=e.nextNode())b=d;return b}var b=a.Event;a.plugins.Paste=function(c){function f(b){var d,f=[],g,h,i=c.selection,j,k,l,m,n;c.getWin().focus(),e&&(r=c.selection.getRng(),r.moveToBookmark(e),r.select()),d=b.split(/\r?\n/);if(d.length>1){b="",a.each(d,function(a){b+="<p>"+a+"</p>"});if(!a.isIE){c.execCommand("Delete"),i.setContent('<span id="marker"></span>'),g=c.dom.getParent(c.dom.get("marker").parentNode,function(a){f.push(a);if(/^(p|h[1-6]|div)$/i.test(a.nodeName))return!0});if(g){c.onPaste.dispatch({text:b}),j=k="";for(l=0;l<f.length;l++)j+="</"+f[l].nodeName.toLowerCase()+">";for(l=f.length-1;l>=0;l--)k+="<"+f[l].nodeName.toLowerCase()+">";b=j+b+k+'<span id="_caret">&nbsp;</span>',c.getBody().innerHTML=c.getBody().innerHTML.replace(/<span id=\"marker\"><\/span>/gi,b),h=c.dom.get("_caret"),a.isGecko||h.scrollIntoView(),m=c.getDoc().createRange(),m.setStartBefore(h),m.setEndAfter(h),i.setRng(m),c.execCommand("Delete");return}n=c.dom.get("marker"),n.parentNode.removeChild(n)}}c.selection.setContent(b),c.onPaste.dispatch({text:b})}function g(a){var b,d,e=c.selection,g=e.getSel(),h,i=c.getBody();b=c.dom.add(i,"div",{id:"_mcePaste",style:"position:absolute;left:-10000px;top:"+i.scrollTop},"&nbsp;"),h=e.getRng(),b=b.firstChild,d=c.getDoc().createRange(),d.setStart(b,0),d.setEnd(b,1),g.removeAllRanges(),g.addRange(d),window.setTimeout(function(){var a=c.dom.get("_mcePaste"),b;b=a.innerHTML,a.parentNode.removeChild(a),h&&e.setRng(h),f(b.replace(/[\r\n]/g,"").replace(/<(\/p|br\s*\/?)>/g,"\n").replace(/<!--.*?-->/g,"").replace(/<[^>]+>/g,""))},0)}var d=a.DOM,e;c.onPaste=new a.Dispatcher(c),c.onInit.add(function(){if(a.isOpera)return;/Firefox\/2/.test(navigator.userAgent)?b.add(c.getDoc(),"keydown",function(b){if((b.metaKey||b.ctrlKey)&&b.keyCode==86||b.shiftKey&&b.keyCode==45)a.isIE&&(e=c.selection.getRng().getBookmark()),g(b)},this):b.add(a.isIE?c.getBody():c.getDoc(),"paste",function(a){var d;if(c.getWin().clipboardData)return f(c.getWin().clipboardData.getData("Text")),b.cancel(a);if(a.clipboardData)return f(a.clipboardData.getData("text/plain")),b.cancel(a);g(a)})})}})(punymce);