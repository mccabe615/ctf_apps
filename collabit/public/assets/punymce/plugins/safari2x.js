(function(a){a.plugins.Safari2x=function(c){function i(a,b){var e=c.getDoc(),f,g;b=b||{},e.execCommand("FontName",!1,"_tmp"),d(c.dom.select("span"),function(c){c.style.fontFamily=="_tmp"&&(f=l(c,a,b),g||(g=f))}),f=f.firstChild,c.selection.getSel().setBaseAndExtent(g,0,f,f.nodeValue.length)}function j(a){var b=c.selection,d;b.setContent("<"+a+'><li id="_tmp"></li></'+a+">"),d=c.dom.get("_tmp"),d.id="",b.select(d),b.collapse(1)}function k(a){return c.dom.getParent(a,function(a){return/^(H[1-6]|P|DIV|ADDRESS|PRE|FORM|TABLE|LI|OL|UL|TD|CODE|CAPTION|BLOCKQUOTE|CENTER|DL|DT|DD|DIR|FIELDSET|NOSCRIPT|NOFRAMES|MENU|ISINDEX|SAMP)$/.test(a.nodeName)})}function l(a,b,e){var f=c.getDoc(),g;return e=e||{},g=f.createElement(b),d(a.attributes,function(a){a.specified&&a.nodeValue&&g.setAttribute(a.nodeName,a.nodeValue)}),d(e,function(a,b){g.setAttribute(b,a)}),d(a.childNodes,function(a){g.appendChild(a.cloneNode(!0))}),a.parentNode.replaceChild(g,a),g}var d=a.each,e=a.Event,f,g,h;if(!a.isOldWebKit)return;c.selection.getRng=function(){var a=this,b=a.getSel(),d=c.getDoc(),e,f,g,h;if(b.anchorNode){e=d.createRange();try{f=d.createRange(),f.setStart(b.anchorNode,b.anchorOffset),f.collapse(1),g=d.createRange(),g.setStart(b.focusNode,b.focusOffset),g.collapse(1),h=f.compareBoundaryPoints(f.START_TO_END,g)<0,e.setStart(h?b.anchorNode:b.focusNode,h?b.anchorOffset:b.focusOffset),e.setEnd(h?b.focusNode:b.anchorNode,h?b.focusOffset:b.anchorOffset)}catch(i){}}return e},g=c.selection.setContent,c.selection.setContent=function(a,e){var f=this.getRng();try{g.call(this,a,e)}catch(h){b=c.dom.create("body"),b.innerHTML=a,d(b.childNodes,function(a){f.insertNode(a.cloneNode(!0))})}},h=c.selection.collapse,c.selection.collapse=function(a){try{h.call(this,a)}catch(b){}},c.onInit.add(function(){a.DOM.get(c.settings.id+"_r").style.display="none"}),c.onPreInit.add(function(){e.add(c.getDoc(),"click",function(a){if(a.target.nodeName=="A")return c.selection.select(a.target),e.cancel(a)}),e.add(c.getDoc(),"keydown",function(a){var b=c.selection,d,f,g,h;if(a.charCode>32||a.keyCode==13){d=c.dom.getParent(b.getNode(),function(a){return a.nodeName=="LI"});if(d){f=b.getRng().startOffset;if(a.keyCode!=13){h=String.fromCharCode(a.charCode);if(!/^\w$/.test(h))return;return b.setContent(h),g=b.getRng(),b=b.getSel(),d=b.anchorNode,d.nodeName=="LI"?b.setBaseAndExtent(d,1,d,1):(d=d.nextSibling,b.setBaseAndExtent(d,1,d,1)),e.cancel(a)}if(!d.hasChildNodes()){if(!d.nextSibling||d.nextSibling.nodeName!="LI"){g=c.dom.getParent(b.getNode(),function(a){return/(UL|OL)/.test(a.nodeName)}),d.parentNode.removeChild(d),b.select(g.nextSibling);return}return e.cancel(a)}h=c.getDoc().createTextNode(" "),d.appendChild(h),window.setTimeout(function(){var a=b.getNode();a.firstChild&&a.firstChild.nodeValue.charAt(0)==" "&&(a.removeChild(a.firstChild),b.select(a))},1)}}})}),a.extend(c.commands,{IncreaseFontSize:function(){var a=c.getDoc(),b=parseInt(a.queryCommandValue("FontSize"));a.execCommand("FontSize",!1,b+1+"px")},DecreaseFontSize:function(){var a=c.getDoc(),b=parseInt(a.queryCommandValue("FontSize"));b>0&&a.execCommand("FontSize",!1,b-1+"px")},Strikethrough:function(){i("strike")},CreateLink:function(a,b){i("a",{href:b,mce_href:b})},Unlink:function(){var a=c.selection;a.setContent(a.getContent().replace(/(<a[^>]+>|<\/a>)/,""))},RemoveFormat:function(){var a=c.selection;a.setContent(a.getContent().replace(/(<(span|b|i|strong|em|strike) [^>]+>|<(span|b|i|strong|em|strike)>|<\/(span|b|i|strong|em|strike)>|)/g,""))},FormatBlock:function(a,b){var d=c.selection,e;e=k(c.selection.getNode()),e&&(r=l(e,b.replace(/<|>/g,""))),d.select(r),d.collapse(1)},InsertUnorderedList:function(){j("ul")},InsertOrderedList:function(){j("ol")},Indent:function(){var a=k(c.selection.getNode()),b;a&&(b=parseInt(a.style.paddingLeft)||0,a.style.paddingLeft=b+10+"px")},Outdent:function(){var a=k(c.selection.getNode()),b;a&&(b=parseInt(a.style.paddingLeft)||0,b>=10&&(a.style.paddingLeft=b-10+"px"))}})}})(punymce);