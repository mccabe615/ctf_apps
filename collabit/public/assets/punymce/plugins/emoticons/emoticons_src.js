(function(a){a.plugins.Emoticons=function(b){function l(a){var b;return d(h.emoticons,function(c,e){return d(c,function(c){if(c==a)return b=e,!1}),!b}),b}var c=a.Event,d,e,f,g,h,i,j,k;d=a.each,e=a.extend,f=a.isIE,g=a.isGecko,j=a.DOM,this.settings=h=e({emoticons:{happy:[":)","=)"],unhappy:[":|","=|"],sad:[":(","=("],grin:[":D","=D"],surprised:[":o",":O","=o","=O"],wink:[";)"],halfhappy:[":/","=/"],tounge:[":P",":p","=P","=p"],lol:[],mad:[],rolleyes:[],cool:[]},row_length:4,trans_img:a.baseURL+"plugins/emoticons/img/trans.gif",skip_css:0,auto_convert:1},b.settings.emoticons),h.skip_css||j.loadCSS(a.baseURL+"/plugins/emoticons/css/editor.css"),i="",d(h.emoticons,function(a){d(a,function(a){i.length!=0&&(i+="|"),i+=a.replace(/([^a-zA-Z0-9])/g,"\\$1")})}),i=new RegExp(i,"g"),e(b.commands,{mceEmoticons:function(a,e,f){function o(a){return b.hideMenu=null,c.remove(document,"click",o),c.remove(b.getDoc(),"click",o),j.get(k+"_memoticons").style.display="none",1}var g,i=this,k=b.settings.id,l=j.getPos(f.target),m,n;if(b.hideMenu)return b.hideMenu();g=j.get(k+"_memoticons"),g||(g=j.get(k+"_t"),g=j.add(document.body,"div",{id:k+"_memoticons","class":"punymce_emoticons punymce"}),g=j.add(g,"table",{"class":"punymce"}),g=j.add(g,"tbody"),m=h.row_length,d(h.emoticons,function(a,d){m==h.row_length&&(r=j.add(g,"tr"),m=0),m++,c.add(j.add(j.add(r,"td"),"a",{href:"#","class":"emoticon "+d}),"mousedown",function(e){return o.call(i),b.selection.setNode(b.dom.create("img",{title:a[0]||d,src:h.trans_img,"class":"emoticon "+d})),c.cancel(e)})})),c.add(document,"click",o,i),c.add(b.getDoc(),"click",o,i),b.hideMenu=o,s=j.get(k+"_memoticons").style,s.left=l.x+"px",s.top=l.y+f.target.clientHeight+2+"px",s.display="block"}}),b.onPreProcess.add(function(a,c){var e=c.node.getElementsByTagName("img"),f=[];d(e,function(a){f.push(a)}),d(f,function(a){var c=b.dom.getAttr(a,"class");c&&c.indexOf("emoticon")!=-1&&a.parentNode.replaceChild(b.getDoc().createTextNode(a.getAttribute("title")),a)})}),b.onSetContent.add(function(a,b){var c=[];k=b.content.replace(/(<\/?[^>]+>|:\/\/)/g,function(a){return a.replace(i,function(a){var b=l(a);return b?(c.push(a),"�"+c.length+"�"):a})}),k=k.replace(i,function(a){return'<img src="'+h.trans_img+'" title="'+a+'" class="emoticon '+l(a)+'" />'}),k=k.replace(/�([^�]+)�/g,function(a,b){return c[parseInt(b)-1]}),b.content=k}),b.onInit.add(function(){var d=b.dom;h.skip_css||d.loadCSS(a.baseURL+"/plugins/emoticons/css/content.css"),c.add(b.getDoc(),"controlselect",function(a){if(d.getAttr(a.target,"class").indexOf("emoticon")!=-1)return c.cancel(a)}),g&&(c.add(b.getDoc(),"mousedown",function(a){if(d.getAttr(a.target,"class").indexOf("emoticon")!=-1)return b.getDoc().execCommand("enableObjectResizing",!1,!1),c.cancel(a);b.getDoc().execCommand("enableObjectResizing",!1,!0)}),c.add(b.getDoc(),"keydown",function(a){var d=b.selection,e=d.getSel(),f=b.getDoc(),g=d.getRng(),h,i,j,k;h=g.startContainer,i=g.startOffset;if(h.nodeType==1)return;if(h){if(a.keyCode==39&&i==h.nodeValue.length){j=h.nextSibling;if(j&&j.nodeName=="IMG")return j=j.nextSibling,g=f.createRange(),g.setStart(j,0),g.setEnd(j,0),e.removeAllRanges(),e.addRange(g),c.cancel(a)}if(a.keyCode==37&&i==0){j=h.previousSibling;if(j&&j.nodeName=="IMG")return j=j.previousSibling,k=j.nodeValue.length,g=f.createRange(),g.setStart(j,k),g.setEnd(j,k),e.removeAllRanges(),e.addRange(g),c.cancel(a)}}})),c.add(b.getDoc(),"keypress",function(e){function r(a){var b,c,d;if(!!f)return q=q.duplicate(),q.moveStart("character",a),q.text;b=q.startContainer,c=q.startOffset,d=q.endOffset;if(c>0&&b.nodeType==3)return b.nodeValue.substring(Math.max(0,c+a),d)}var g,j,k,m,n=b.getDoc(),o=b.selection,p=o.getSel(),q=o.getRng();if(a.isOldWebKit||!h.auto_convert)return!0;if(/(ttp|ftp):/i.test(r(-4)))return;k=r(-1),g=k+String.fromCharCode(e.charCode||e.keyCode),i.lastIndex=0;if(!k||!i.test(g)||m=="/")return;if(j=l(g))return f?(q=b.selection.getRng(),q.moveStart("character",-1),q.select()):(q.setStart(q.startContainer,q.startOffset-1),p.removeAllRanges(),p.addRange(q)),b.selection.setNode(d.create("img",{id:"emoticon",title:g,src:h.trans_img,"class":"emoticon "+j})),g=d.get("emoticon"),d.setAttr(g,"id",""),b.selection.select(g),b.selection.collapse(0),c.cancel(e)})}),e(b.tools,{emoticons:{cmd:"mceEmoticons",title:a.I18n.emoticons}})},a.extend(a.I18n,{emoticons:"Insert emoticon"})})(punymce);